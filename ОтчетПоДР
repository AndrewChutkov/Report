Перем ЗначениеПоляВводаМесяца Экспорт;
Перем ДеньХ Экспорт;

Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура СформироватьОтчетНажатие(Элемент)
	ФормированиеОтчетаПоДнямРождениямЗаМесяц();
	ОтправкаНаПочту();
КонецПроцедуры

//Формирование отчета за указанный месяц
Процедура ФормированиеОтчетаПоДнямРождениямЗаМесяц();
	
	Запрос = Новый Запрос;
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ПостроительОтчета = Новый ПостроительОтчета;
	
	//Берем значение из поля ввода
	ЗначениеПоляВводаМесяца = ЭтаФорма.ЭлементыФормы.Месяц.Значение;
	ДеньХ = Дата("00010101");
	
	Запрос.Текст = "ВЫБРАТЬ
	               |	Карты.Клиент.Фамилия КАК Фамилия,
	               |	Карты.Клиент.Имя КАК Имя,
	               |	Карты.Клиент.Отчество КАК Отчество,
	               |	Карты.Клиент.ДатаРождения КАК ДатаРождения,
	               |	Карты.Клиент.Телефон,
	               |	Карты.ДатаВыдачи,
	               |	Карты.МестоВыдачи
	               |ИЗ
	               |	Справочник.Карты КАК Карты
	               |ГДЕ
	               |	Карты.Клиент.Родитель.Код = ""000000027""
	               |	И МЕСЯЦ(Карты.Клиент.ДатаРождения) = &Месяц
	               |	И НЕ Карты.Клиент.ДатаРождения = &ДеньХ";
	Запрос.УстановитьПараметр("Месяц", ЗначениеПоляВводаМесяца);
	Запрос.УстановитьПараметр("ДеньХ", ДеньХ);
	РезультатЗапроса = Запрос.Выполнить();
	ПостроительОтчета.ИсточникДанных  = Новый ОписаниеИсточникаДанных(РезультатЗапроса);
	ПостроительОтчета.Вывести(ТабличныйДокумент);
	ТабличныйДокумент.Записать("F:\ОтчетыДляВалентины\ОтчетПоДнямРождениямЗа_" + ЗначениеПоляВводаМесяца + "_Месяц.xls", ТипФайлаТабличногоДокумента.XLS)
	
КонецПроцедуры

//Отправляем сформированные отчеты на почту
Процедура ОтправкаНаПочту()
	
	//Указываем параметры подключения к SMTP-серверу	
	ИПП = Новый ИнтернетПочтовыйПрофиль;
	ИПП.АдресСервераSMTP = "smtp.mail.ru";
	ИПП.ПарольSMTP = "//пароль";
	ИПП.ПользовательSMTP = "andrei_chutkov@mail.ru";
	ИПП.ПортSMTP = 465;
	ИПП.АутентификацияSMTP = СпособSMTPАутентификации.Login;
	ИПП.ИспользоватьSSLSMTP = Истина;
	 
	
	//Формируем письмо
	Сообщение = Новый ИнтернетПочтовоеСообщение;
	Сообщение.Получатели.Добавить("//получатель");	
	Сообщение.Отправитель.Адрес = "andrei_chutkov@mail.ru";
	Сообщение.Тема = "Отчет по дням рождениям за  месяц " + ЗначениеПоляВводаМесяца + ", для магазинов";
	Сообщение.Вложения.Добавить("F:\ОтчетыДляВалентины\ОтчетПоДнямРождениямЗа_" + ЗначениеПоляВводаМесяца + "_Месяц.xls", "Отчет");
	
	
	//Отправка
	Почта = Новый ИнтернетПочта;
    Почта.Подключиться(ИПП);                              
    Почта.Послать(Сообщение);
    Почта.Отключиться();
	
КонецПроцедуры
